`ggbipart`, an `R` package for plotting bipartite networks
========================================================

This is a series of `R` functions aimed to plot bipartite networks within the `ggplot2` environment. The library relies heavily on code developed by Francois Briatte for the `ggnet` library.    

Bipartite networks are a special type of network where nodes are of two distinct types or sets, so that connections (links) only exist among nodes of the different sets.

As in other types of network, bipartite strucures can be binary (only the presence/absence of the links is mapped) or quantitative (weighted), where the links can have variable importance or weight.

To plot, we start with an adjacency or incidence matrix. I'm using matrices that illustrate ecological interactions among species, such as the mutualisttic interactions of animal pollinators and plant flowers. The two sets (modes) of these bipartite netwroks are animals (pollinators) ans plants species.

From any adjacency matrix we can get a `network` object or an `igraph` object for plotting and analysis. 

-----------------------------------------------------------------------------
### Required packages
```{r packages, echo=T, eval=TRUE, message=FALSE, warning=FALSE}
require(network)
require(igraph)
require(sna)
require(ggplot2)
require(ggnet)
require(sna)
require(ergm)

```
-----------------------------------------------------------------------------

Here I plot bipartite networks from their adjacency matrices, i.e., the two-mode networks. The standard way to input an adjacency matrix is from a `.txt or a `.csv` file.


### Initializing bipartite webs as `network` objects

```{r input_data1, eval=FALSE, echo=TRUE}
#-------------------------------------------------------------------------
# Read data matrices.
# Read a network
# Creating the objects. Example input from the clipboard. 
# 
mymat <- read.delim("data.txt", row.names=1)   # Not run.
#
# Where data.txt has a weighted adjacency matrix, e.g.,:
    Aa	Ab	Ac	Ba	Bb	Bc	Bd	Ca	Cb	Cc	Da
P1	139	60	 9	23	4	104	5	3	5	2	1
P2	184	26	6	10	3	6	17	11	3	1	0
P3	131	74	33	36	13	19	0	9	0	1	0
P4	87	40	38	21	13	0	9	0	1	0	0
P5	100	42	17	12	4	1	1	0	0	0	0
P6	21	15	7	0	4	1	0	0	0	0	0
P7	42	16	3	0	2	0	0	0	0	0	0
P8	31	8	4	5	1	0	0	1	0	0	0
P9	46	8	2	0	3	0	0	0	0	0	0
P10	86	0	0	12	0	2	2	0	0	0	0
P11	23	8	1	5	0	0	0	0	0	0	0
P12	13	6	1	1	0	1	0	0	0	0	0
P13	5	0	1	0	0	0	0	0	0	0	0
P14	9	1	0	0	0	0	0	0	0	0	0

# Use this to copy from the clipboard, after select/copy the above block.
mymat <- read.table(pipe("pbpaste"), header= T, sep= "\t", row.names= 1)

```


The adjacency matrix is just read from the clipboard as a tab-separated file with header names, and the first column is taken as the row names. 

This next example (from F. Briatte code) initializes a dataframe:

```{r input_data2, eval=FALSE, echo=TRUE}
# A weighted adjacency matrix. Rows are animal species; columns are plant 
# species.
bip= data.frame(P1= c(1, 12, 6, 0),
                P2= c(1, 0, 4, 0),
                P3= c(1, 7, 3, 12),
     row.names= letters[1:4])

```


These are two example datasets of well-sampled plant-frugivore interaction networks from S Spain, read in the usual way.

```{r read_data, eval=TRUE, echo=TRUE}
#-------------------------------------------------------------------------
# The Nava de las Correhuelas dataset.
nch <- read.table("./data-raw/NCH_quant_bmatrix.txt", 
                  header=T, sep="\t", row.names=1,
                  dec=",", na.strings="NA")
# The Hato Raton dataset.
hr <- read.table("./data-raw/HR_quant_bmatrix.txt", 
                  header=T, sep="\t", row.names=1,
                  dec=".", na.strings="NA")

```


Here I use the function `bip_init_network` to initialize a few examples of  bipartite networks. The function returns a `network` object. The equivelent fucntion `bip_init_igraph` returns an `igraph` (graph) object.

```{r init_graphs, eval=TRUE, echo=TRUE}
source("./R/bip_init_network.R")
source("./R/bip_init_igraph.R")

test.net<- bip_init_network(mymat)
test.ig<- bip_init_igraph(mymat)
nch.net <- bip_init_network(nch) 
nch.ig<- bip_init_igraph(nch)
hr.net <- bip_init_network(hr)

```
----------------------------------------------------------------------------
### Functions to plot network graphs

#### bip_qtplot
Simple function to plot a weighted bipartite network in `network` object. The input is just the weighted (quantitative) adjacency matrix of a two-mode network. Uses objects of type `network`.

#### bip_railway
Simple function to plot a bipartite network with the classic layout of two parallel sets of nodes.

#### bip_ggnet
Plotting bipartite networks from adjacency matrix of two-mode network. 

#### bip_igplot
Function to plot a weighted bipartite network in `igraph`. Its inputs are the 
adjacency matrix, to get the dimensions from, and the igraph object 
corresponding to the matrix.

A better implementation is to use `bip_ggnet` function (see example below), which uses my initialization codes and the modifications to get the bipartite 
networks in `ggplot2`, using the [package `ggnet`](https://briatte.github.io/ggnet/) usage.

```{r source_functions, eval=TRUE, echo=TRUE}
# Sourcing required functions and initializing the net objects.
source("./R/bip_binplot.R")
source("./R/bip_igplot.R")
source("./R/bip_qtplot.R")
source("./R/vectorize.R")

```

----------------------------------------------------------------------------

### Using `ggnet` for bipartite graphs
#### Bipartite networks with `ggnet` using the `ggplot2` framework

I'm using the `gplot.layout.fruchtermanreingold` layout, but just tweak 
the code to get a Kamada-Kawai ordination, for example. We just source this 
file after assigning the input adjacency matrix and the input graph:

```{r ggplot_prototype, eval=TRUE, echo=TRUE, fig.width= 8, fig.height=6}
#-------------------------------------------------------------------------
# Assign the matrix and the network objects here.
# mymat is a matrix with column names and row names.
# net is a network object.
# This is for the Nava de las Correhuelas network.
#-------------------------------------------------------------------------
mymat <- nch
net <- nch.net
# 
# Now we source the bip_ggplot2.R file
source("bip_ggplot2.R")
# 
# We repeat for the Hato Raton network.
mymat <- hr
net <- hr.net
source("bip_ggplot2.R")
```

### Using FranÃ§ois Briatte's `ggnet` function

```{r ggnet_plot, eval=TRUE, echo=TRUE, fig.width= 10, fig.height=8, warning=FALSE}
#-------------------------------------------------------------------------
# Plotting bipartite networks from adjacency matrix of two-mode network.
# Using ggplot2. Code from Francois Briatte, using his function ggnet.
# DATE: 15Jul2013.
#
require(downloader)
#
# PJ example. Based on a gist by F Briatte to just feed the network data 
# from its adjacency matrix to ggnet
#-------------------------------------------------------------------------
link = "https://raw.github.com/pedroj/bipartite_plots/master/data/NCH_quant_bmatrix.txt"
file = "data/NCH_quant_bmatrix.txt"
if(!file.exists(file)) download(link, file, mode = "wb")
M <- read.table(file, sep = "\t", dec = ",", header = TRUE, row.names = 1)
# ...
# Bipartite network initialization, starting from a weighted adjacency matrix.
# ...
source("functions/bip_briatte.R")
source_url("https://raw.github.com/briatte/ggnet/master/ggnet.R", prompt = FALSE)
# ...
# Pass the network, edge weights and mode to ggnet.
# ...
net = bipartite.network(M, modes = c("Animals", "Plants"))
ggnet(net,
      segment.size = edge.weights(M, 15), segment.alpha = .35,
      label = TRUE, color = "black",
      node.group = get.vertex.attribute(net, "mode"))
```


